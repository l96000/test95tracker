// Fajl: api/get-data.js

import fetch from 'node-fetch';

// --- 1. KOMPLETAN RED VOŽNJE (Vaši podaci) ---
const timetableMapA = {
"04:50:00": 1,

"05:10:00": 6,
"05:25:00": 11,
"05:35:00": 14,
"05:45:00": 17,
"05:54:00": 19,

"06:03:00": 20,
"06:12:00": 22,
"06:21:00": 1,
"06:27:00": 2,
"06:32:00": 3,
"06:36:00": 5,
"06:41:00": 6,
"06:45:00": 7,
"06:50:00": 8,
"06:54:00": 24,
"06:59:00": 9,

"07:03:00": 10,
"07:07:00": 11,
"07:12:00": 12,
"07:16:00": 13,
"07:21:00": 14,
"07:25:00": 15,
"07:30:00": 16,
"07:34:00": 17,
"07:39:00": 18,
"07:43:00": 19,
"07:48:00": 25,
"07:52:00": 20,
"07:56:00": 21,

"08:01:00": 22,
"08:05:00": 23,
"08:10:00": 1,
"08:14:00": 2,
"08:19:00": 3,
"08:23:00": 4,
"08:28:00": 5,
"08:32:00": 6,
"08:37:00": 7,
"08:41:00": 8,
"08:43:00": 24,
"08:46:00": 9,
"08:50:00": 10,
"08:55:00": 11,
"08:59:00": 12,

"09:04:00": 13,
"09:08:00": 14,
"09:13:00": 15,
"09:17:00": 16,
"09:22:00": 17,
"09:26:00": 18,
"09:31:00": 19,
"09:33:00": 25,
"09:35:00": 20,
"09:40:00": 21,
"09:44:00": 22,
"09:49:00": 23,
"09:53:00": 1,
"09:58:00": 2,

"10:03:00": 3,
"10:07:00": 4,
"10:12:00": 5,
"10:16:00": 6,
"10:21:00": 7,
"10:25:00": 8,
"10:30:00": 9,
"10:34:00": 10,
"10:39:00": 11,
"10:43:00": 12,
"10:48:00": 13,
"10:52:00": 14,
"10:57:00": 15,

"11:01:00": 16,
"11:06:00": 17,
"11:10:00": 18,
"11:15:00": 19,
"11:19:00": 20,
"11:24:00": 21,
"11:28:00": 22,
"11:33:00": 23,
"11:37:00": 1,
"11:42:00": 2,
"11:47:00": 3,
"11:51:00": 4,
"11:56:00": 5,

"12:00:00": 6,
"12:05:00": 7,
"12:09:00": 8,
"12:14:00": 9,
"12:18:00": 10,
"12:23:00": 11,
"12:27:00": 12,
"12:32:00": 13,
"12:36:00": 14,
"12:41:00": 15,
"12:45:00": 16,
"12:50:00": 25,
"12:54:00": 17,
"12:59:00": 18,

"13:04:00": 19,
"13:08:00": 20,
"13:13:00": 21,
"13:17:00": 22,
"13:21:00": 23,
"13:26:00": 24,
"13:30:00": 1,
"13:35:00": 2,
"13:39:00": 3,
"13:43:00": 4,
"13:48:00": 5,
"13:52:00": 6,
"13:56:00": 7,

"14:01:00": 8,
"14:05:00": 9,
"14:10:00": 10,
"14:14:00": 26,
"14:18:00": 11,
"14:23:00": 12,
"14:27:00": 13,
"14:32:00": 14,
"14:36:00": 15,
"14:40:00": 16,
"14:45:00": 25,
"14:49:00": 17,
"14:53:00": 18,
"14:58:00": 19,

"15:02:00": 20,
"15:06:00": 21,
"15:10:00": 22,
"15:15:00": 23,
"15:19:00": 24,
"15:23:00": 1,
"15:28:00": 2,
"15:32:00": 3,
"15:36:00": 4,
"15:41:00": 5,
"15:45:00": 6,
"15:49:00": 7,
"15:54:00": 8,
"15:58:00": 9,

"16:03:00": 10,
"16:07:00": 26,
"16:11:00": 11,
"16:16:00": 12,
"16:20:00": 13,
"16:25:00": 14,
"16:29:00": 15,
"16:33:00": 16,
"16:38:00": 25,
"16:42:00": 17,
"16:46:00": 18,
"16:51:00": 19,
"16:55:00": 20,

"17:00:00": 21,
"17:05:00": 22,
"17:09:00": 23,
"17:14:00": 24,
"17:18:00": 1,
"17:23:00": 2,
"17:27:00": 3,
"17:31:00": 4,
"17:36:00": 5,
"17:40:00": 6,
"17:44:00": 7,
"17:49:00": 8,
"17:53:00": 9,
"17:58:00": 10,

"18:02:00": 26,
"18:06:00": 11,
"18:11:00": 12,
"18:15:00": 13,
"18:20:00": 14,
"18:24:00": 15,
"18:28:00": 16,
"18:33:00": 25,
"18:35:00": 17,
"18:38:00": 18,
"18:42:00": 19,
"18:47:00": 20,
"18:52:00": 21,
"18:56:00": 22,

"19:01:00": 23,
"19:06:00": 24,
"19:07:00": 1,
"19:11:00": 2,
"19:15:00": 3,
"19:20:00": 4,
"19:25:00": 5,
"19:29:00": 7,
"19:34:00": 8,
"19:39:00": 9,
"19:43:00": 10,
"19:48:00": 26,
"19:53:00": 12,
"19:57:00": 13,

"20:02:00": 14,
"20:07:00": 15,
"20:12:00": 16,
"20:16:00": 25,
"20:21:00": 18,
"20:26:00": 19,
"20:30:00": 20,
"20:35:00": 21,
"20:40:00": 22,
"20:45:00": 23,
"20:49:00": 24,
"20:54:00": 2,
"20:59:00": 3,

"21:05:00": 4,
"21:09:00": 5,
"21:11:00": 7,
"21:17:00": 8,
"21:20:00": 9,
"21:24:00": 10,
"21:24:00": 12,
"21:30:00": 13,
"21:37:00": 14,
"21:43:00": 16,
"21:50:00": 25,
"21:56:00": 19,

"22:03:00": 20,
"22:09:00": 22,
"22:16:00": 23,
"22:22:00": 24,
"22:29:00": 2,
"22:36:00": 4,
"22:43:00": 7,
"22:51:00": 8,

"23:00:00": 12,
"23:05:00": 13,
"23:10:00": 16,
"23:20:00": 25,
"23:35:00": 20,
"23:50:00": 23
};
const timetableMapB = {
"04:15:00": 1,
"04:55:00": 17,

"05:15:00": 20,
"05:30:00": 1,
"05:39:00": 4,
"05:47:00": 6,
"05:54:00": 7,

"06:00:00": 24,
"06:06:00": 11,
"06:11:00": 12,
"06:15:00": 13,
"06:20:00": 14,
"06:24:00": 15,
"06:29:00": 16,
"06:33:00": 17,
"06:38:00": 18,
"06:42:00": 19,
"06:47:00": 25,
"06:51:00": 20,
"06:56:00": 21,

"07:00:00": 22,
"07:05:00": 23,
"07:09:00": 1,
"07:14:00": 2,
"07:18:00": 3,
"07:23:00": 4,
"07:27:00": 5,
"07:32:00": 6,
"07:36:00": 7,
"07:41:00": 8,
"07:45:00": 24,
"07:50:00": 9,
"07:54:00": 10,
"07:59:00": 11,

"08:03:00": 12,
"08:08:00": 13,
"08:12:00": 14,
"08:17:00": 15,
"08:21:00": 16,
"08:26:00": 17,
"08:30:00": 18,
"08:35:00": 19,
"08:39:00": 25,
"08:44:00": 20,
"08:48:00": 21,
"08:53:00": 22,
"08:57:00": 23,

"09:02:00": 1,
"09:06:00": 2,
"09:11:00": 3,
"09:15:00": 4,
"09:20:00": 5,
"09:24:00": 6,
"09:29:00": 7,
"09:33:00": 8,
"09:38:00": 9,
"09:42:00": 10,
"09:47:00": 11,
"09:51:00": 12,
"09:56:00": 13,

"10:00:00": 14,
"10:05:00": 15,
"10:09:00": 16,
"10:14:00": 17,
"10:18:00": 18,
"10:23:00": 19,
"10:27:00": 20,
"10:32:00": 21,
"10:36:00": 22,
"10:41:00": 23,
"10:45:00": 1,
"10:50:00": 2,
"10:55:00": 3,
"10:59:00": 4,

"11:04:00": 5,
"11:08:00": 6,
"11:13:00": 7,
"11:17:00": 8,
"11:22:00": 9,
"11:26:00": 10,
"11:31:00": 11,
"11:35:00": 12,
"11:40:00": 13,
"11:44:00": 14,
"11:49:00": 15,
"11:53:00": 16,
"11:58:00": 17,

"12:02:00": 18,
"12:07:00": 19,
"12:12:00": 20,
"12:16:00": 21,
"12:21:00": 22,
"12:25:00": 23,
"12:30:00": 24,
"12:34:00": 1,
"12:39:00": 2,
"12:43:00": 3,
"12:47:00": 4,
"12:52:00": 5,
"12:56:00": 6,

"13:00:00": 7,
"13:05:00": 8,
"13:09:00": 9,
"13:14:00": 10,
"13:18:00": 26,
"13:22:00": 11,
"13:27:00": 12,
"13:31:00": 13,
"13:36:00": 14,
"13:40:00": 15,
"13:44:00": 16,
"13:49:00": 25,
"13:53:00": 17,
"13:57:00": 18,

"14:02:00": 19,
"14:06:00": 20,
"14:11:00": 21,
"14:15:00": 22,
"14:19:00": 23,
"14:24:00": 24,
"14:28:00": 1,
"14:33:00": 2,
"14:37:00": 3,
"14:41:00": 4,
"14:46:00": 5,
"14:50:00": 6,
"14:54:00": 7,
"14:59:00": 8,

"15:03:00": 9,
"15:08:00": 10,
"15:12:00": 26,
"15:16:00": 11,
"15:21:00": 12,
"15:25:00": 13,
"15:30:00": 14,
"15:34:00": 15,
"15:38:00": 16,
"15:43:00": 25,
"15:47:00": 17,
"15:51:00": 18,
"15:56:00": 19,

"16:00:00": 20,
"16:05:00": 21,
"16:10:00": 22,
"16:14:00": 23,
"16:19:00": 24,
"16:23:00": 1,
"16:28:00": 2,
"16:32:00": 3,
"16:36:00": 4,
"16:41:00": 5,
"16:45:00": 6,
"16:49:00": 7,
"16:54:00": 8,
"16:58:00": 9,

"17:03:00": 10,
"17:07:00": 26,
"17:11:00": 11,
"17:16:00": 12,
"17:20:00": 13,
"17:25:00": 14,
"17:29:00": 15,
"17:33:00": 16,
"17:38:00": 25,
"17:42:00": 17,
"17:46:00": 18,
"17:51:00": 19,
"17:55:00": 20,
"17:59:00": 21,

"18:04:00": 22,
"18:08:00": 23,
"18:12:00": 24,
"18:16:00": 1,
"18:21:00": 2,
"18:25:00": 3,
"18:30:00": 4,
"18:35:00": 5,
"18:37:00": 6,
"18:39:00": 7,
"18:44:00": 8,
"18:48:00": 9,
"18:53:00": 10,
"18:57:00": 26,

"19:02:00": 12,
"19:06:00": 13,
"19:11:00": 14,
"19:15:00": 15,
"19:20:00": 16,
"19:24:00": 25,
"19:29:00": 18,
"19:34:00": 19,
"19:38:00": 20,
"19:43:00": 21,
"19:48:00": 22,
"19:53:00": 23,
"19:57:00": 24,

"20:02:00": 2,
"20:07:00": 3,
"20:11:00": 4,
"20:16:00": 5,
"20:21:00": 7,
"20:26:00": 8,
"20:30:00": 9,
"20:35:00": 10,
"20:38:00": 26,
"20:40:00": 12,
"20:45:00": 13,
"20:51:00": 14,
"20:54:00": 15,
"20:57:00": 16,

"21:04:00": 25,
"21:09:00": 18,
"21:10:00": 19,
"21:17:00": 20,
"21:18:00": 21,
"21:23:00": 22,
"21:30:00": 23,
"21:36:00": 24,
"21:43:00": 2,
"21:45:00": 3,
"21:50:00": 4,
"21:57:00": 7,

"22:05:00": 8,
"22:13:00": 12,
"22:21:00": 13,
"22:22:00": 14,
"22:30:00": 16,
"22:40:00": 25,
"22:42:00": 19,
"22:50:00": 20,
"22:55:00": 22,

"23:05:00": 23,
"23:07:00": 24,
"23:13:00": 2,
"23:20:00": 4,
"23:25:00": 7,
"23:35:00": 8,
"23:46:00": 12,
"23:58:00": 16,
};
const URLS = [
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20599", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20586", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20052", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=22111", timetable: timetableMapB },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20556", timetable: timetableMapB },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20562", timetable: timetableMapB },
];
const CLEAN_REGEX = /[^\d:.]/g;

// --- 2. OVO JE GLAVNA VERCEL FUNKCIJA ---
export default async function handler(request, response) {
    let allResults = [];
    
    for (const { url, timetable } of URLS) {
        try {
            const apiResponse = await fetch(url);
            if (!apiResponse.ok) continue;
            
            const data = await apiResponse.json();
            const arrivals = data.data && data.data.arrivals ? data.data.arrivals : null;
            if (!arrivals || arrivals.length === 0) continue;

            arrivals
                .filter((bus) => bus.lc === "26")
                .forEach((bus) => {
                    const vehicleId = bus.i;
                    let apiTime = bus.dt;
                    if (!apiTime) return;

                    apiTime = apiTime.trim().replace(CLEAN_REGEX, '');
                    if (apiTime.includes('.')) apiTime = apiTime.split('.')[0];
                    if (apiTime.length === 5 && apiTime.includes(':')) apiTime = apiTime + ":00";
                    
                    const blockNumber = timetable[apiTime];

                    if (blockNumber) {
                        allResults.push({
                            time: apiTime,
                            block: blockNumber,
                            vehicle: vehicleId,
                        });
                    }
                });
        } catch (error) {
            // Ignorišemo greške pojedinačnih stanica
            console.error(`Greška pri dohvatanju ${url}:`, error.message);
        }
    }

    // Filtriranje i sortiranje
    const uniqueResults = allResults.filter((item, index, self) =>
        index === self.findIndex((t) => (t.block === item.block && t.vehicle === item.vehicle))
    );
    uniqueResults.sort((a, b) => a.block - b.block);

    // --- 3. SLANJE PODATAKA STRANICI ---
    // Umesto console.log, šaljemo JSON odgovor
    
    // Kažemo pregledaču da kešira odgovor na 1 minut (60 sekundi)
    // Ovo sprečava da vaš sajt obara prometko.si ako imate puno poseta
    response.setHeader('Cache-Control', 's-maxage=60, stale-while-revalidate=300');
    
    response.status(200).json({
        lastUpdated: new Date().toISOString(),
        results: uniqueResults
    });
}