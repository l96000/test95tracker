// Fajl: api/get-data.js

import fetch from 'node-fetch';

// --- 1. KOMPLETAN RED VOŽNJE (Vaši podaci) ---
const timetableMapA = {

  "04:00:00": 15,
  "04:20:00": 16,
  "04:40:00": 22,
  "05:00:00": 1,
  "05:15:00": 4,
  "05:27:00": 7,
  "05:37:00": 9,
  "05:45:00": 10,
  "05:53:00": 11,
  "06:01:00": 13,
  "06:05:00": 15,
  "06:12:00": 16,
  "06:17:00": 17,
  "06:22:00": 18,
  "06:27:00": 25,
  "06:32:00": 19,
  "06:36:00": 20,
  "06:41:00": 21,
  "06:45:00": 22,
  "06:50:00": 23,
  "06:55:00": 26,
  "06:59:00": 24,
  "07:04:00": 1,
  "07:09:00": 2,
  "07:13:00": 3,
  "07:18:00": 4,
  "07:22:00": 5,
  "07:27:00": 6,
  "07:32:00": 7,
  "07:36:00": 8,
  "07:41:00": 9,
  "07:45:00": 10,
  "07:50:00": 11,
  "07:55:00": 12,
  "07:59:00": 13,
  "08:04:00": 14,
  "08:09:00": 15,
  "08:13:00": 16,
  "08:18:00": 17,
  "08:22:00": 18,
  "08:27:00": 25,
  "08:32:00": 19,
  "08:36:00": 20,
  "08:41:00": 21,
  "08:45:00": 22,
  "08:50:00": 23,
  "08:55:00": 26,
  "08:59:00": 24,
  "09:04:00": 1,
  "09:09:00": 2,
  "09:14:00": 3,
  "09:19:00": 4,
  "09:25:00": 5,
  "09:30:00": 6,
  "09:35:00": 7,
  "09:40:00": 8,
  "09:45:00": 9,
  "09:50:00": 10,
  "09:55:00": 11,
  "10:00:00": 12,
  "10:06:00": 13,
  "10:11:00": 14,
  "10:16:00": 15,
  "10:21:00": 16,
  "10:26:00": 17,
  "10:31:00": 18,
  "10:37:00": 19,
  "10:42:00": 20,
  "10:47:00": 21,
  "10:53:00": 22,
  "10:58:00": 23,
  "11:03:00": 24,
  "11:09:00": 1,
  "11:14:00": 2,
  "11:19:00": 3,
  "11:25:00": 4,
  "11:30:00": 5,
  "11:35:00": 6,
  "11:40:00": 7,
  "11:45:00": 8,
  "11:50:00": 9,
  "11:54:00": 10,
  "11:59:00": 11,
  "12:04:00": 12,
  "12:09:00": 13,
  "12:14:00": 14,
  "12:19:00": 15,
  "12:23:00": 16,
  "12:28:00": 17,
  "12:33:00": 18,
  "12:38:00": 19,
  "12:43:00": 26,
  "12:48:00": 20,
  "12:53:00": 21,
  "12:57:00": 22,
  "13:02:00": 23,
  "13:07:00": 24,
  "13:12:00": 1,
  "13:17:00": 2,
  "13:22:00": 3,
  "13:26:00": 25,
  "13:31:00": 4,
  "13:36:00": 5,
  "13:41:00": 6,
  "13:46:00": 7,
  "13:51:00": 8,
  "13:56:00": 9,
  "14:01:00": 10,
  "14:06:00": 11,
  "14:11:00": 12,
  "14:16:00": 13,
  "14:21:00": 14,
  "14:26:00": 15,
  "14:31:00": 16,
  "14:36:00": 17,
  "14:41:00": 18,
  "14:47:00": 19,
  "14:52:00": 26,
  "14:57:00": 20,
  "15:02:00": 21,
  "15:07:00": 22,
  "15:12:00": 23,
  "15:17:00": 24,
  "15:22:00": 1,
  "15:27:00": 2,
  "15:32:00": 3,
  "15:37:00": 25,
  "15:42:00": 4,
  "15:47:00": 5,
  "15:52:00": 6,
  "15:57:00": 7,
  "16:02:00": 8,
  "16:07:00": 9,
  "16:12:00": 10,
  "16:17:00": 11,
  "16:22:00": 12,
  "16:28:00": 13,
  "16:33:00": 14,
  "16:38:00": 15,
  "16:44:00": 16,
  "16:49:00": 17,
  "16:54:00": 18,
  "17:00:00": 19,
  "17:05:00": 26,
  "17:10:00": 20,
  "17:15:00": 21,
  "17:20:00": 22,
  "17:25:00": 23,
  "17:31:00": 24,
  "17:36:00": 1,
  "17:41:00": 2,
  "17:46:00": 3,
  "17:51:00": 25,
  "17:57:00": 4,
  "18:02:00": 5,
  "18:07:00": 6,
  "18:12:00": 7,
  "18:18:00": 8,
  "18:23:00": 9,
  "18:28:00": 10,
  "18:33:00": 11,
  "18:39:00": 12,
  "18:44:00": 13,
  "18:49:00": 14,
  "18:55:00": 15,
  "19:00:00": 16,
  "19:05:00": 17,
  "19:08:00": 18,
  "19:11:00": 19,
  "19:16:00": 26,
  "19:21:00": 20,
  "19:26:00": 21,
  "19:30:00": 22,
  "19:32:00": 23,
  "19:37:00": 24,
  "19:42:00": 1,
  "19:48:00": 2,
  "19:53:00": 3,
  "19:58:00": 25,
  "20:03:00": 4,
  "20:09:00": 5,
  "20:14:00": 6,
  "20:19:00": 7,
  "20:24:00": 8,
  "20:30:00": 9,
  "20:35:00": 10,
  "20:40:00": 11,
  "20:45:00": 12,
  "20:50:00": 13,
  "20:55:00": 14,
  "21:00:00": 15,
  "21:06:00": 17,
  "21:12:00": 19,
  "21:18:00": 26,
  "21:24:00": 20,
  "21:30:00": 21,
  "21:33:00": 23,
  "21:36:00": 24,
  "21:42:00": 1,
  "21:48:00": 2,
  "21:55:00": 3,
  "21:58:00": 5,
  "22:04:00": 6,
  "22:14:00": 7,
  "22:22:00": 8,
  "22:25:00": 9,
  "22:36:00": 11,
  "22:48:00": 12,
  "22:52:00": 13,
  "22:55:00": 14,
  "22:59:00": 17,
  "23:00:00": 19,
  "23:12:00": 26,
  "23:25:00": 20,
  "23:27:00": 24,
  "23:35:00": 1,
  "23:40:00": 2,
  "00:00:00": 6,
  "00:14:00": 9,
  "00:29:00": 11,
  "00:44:00": 19

};
const timetableMapB = {
 "04:00:00": 1,
  "04:20:00": 4,
  "04:40:00": 9,
  "05:00:00": 15,
  "05:15:00": 16,
  "05:25:00": 25,
  "05:35:00": 20,
  "05:44:00": 22,
  "05:50:00": 26,
  "05:56:00": 24,
  "06:02:00": 1,
  "06:08:00": 2,
  "06:13:00": 3,
  "06:18:00": 4,
  "06:23:00": 6,
  "06:28:00": 7,
  "06:32:00": 8,
  "06:37:00": 9,
  "06:41:00": 10,
  "06:46:00": 11,
  "06:51:00": 12,
  "06:55:00": 13,
  "07:00:00": 14,
  "07:05:00": 15,
  "07:09:00": 16,
  "07:14:00": 17,
  "07:18:00": 18,
  "07:23:00": 25,
  "07:28:00": 19,
  "07:32:00": 20,
  "07:37:00": 21,
  "07:41:00": 22,
  "07:46:00": 23,
  "07:51:00": 26,
  "07:55:00": 24,
  "08:00:00": 1,
  "08:05:00": 2,
  "08:09:00": 3,
  "08:14:00": 4,
  "08:18:00": 5,
  "08:23:00": 6,
  "08:28:00": 7,
  "08:33:00": 8,
  "08:39:00": 9,
  "08:44:00": 10,
  "08:49:00": 11,
  "08:54:00": 12,
  "08:59:00": 13,
  "09:05:00": 14,
  "09:10:00": 15,
  "09:15:00": 16,
  "09:20:00": 17,
  "09:25:00": 25,
  "09:26:00": 18,
  "09:31:00": 19,
  "09:36:00": 20,
  "09:41:00": 21,
  "09:46:00": 22,
  "09:52:00": 23,
  "09:55:00": 26,
  "09:57:00": 24,
  "10:02:00": 1,
  "10:07:00": 2,
  "10:12:00": 3,
  "10:18:00": 4,
  "10:23:00": 5,
  "10:28:00": 6,
  "10:33:00": 7,
  "10:38:00": 8,
  "10:43:00": 9,
  "10:48:00": 10,
  "10:53:00": 11,
  "10:58:00": 12,
  "11:04:00": 13,
  "11:09:00": 14,
  "11:14:00": 15,
  "11:19:00": 16,
  "11:24:00": 17,
  "11:29:00": 18,
  "11:34:00": 19,
  "11:39:00": 20,
  "11:44:00": 21,
  "11:49:00": 22,
  "11:54:00": 23,
  "11:59:00": 24,
  "12:05:00": 1,
  "12:10:00": 2,
  "12:15:00": 3,
  "12:20:00": 25,
  "12:25:00": 4,
  "12:30:00": 5,
  "12:35:00": 6,
  "12:40:00": 7,
  "12:45:00": 8,
  "12:50:00": 9,
  "12:54:00": 10,
  "12:59:00": 11,
  "13:04:00": 12,
  "13:09:00": 13,
  "13:14:00": 14,
  "13:19:00": 15,
  "13:23:00": 16,
  "13:28:00": 17,
  "13:33:00": 18,
  "13:38:00": 19,
  "13:43:00": 26,
  "13:48:00": 20,
  "13:53:00": 21,
  "13:57:00": 22,
  "14:02:00": 23,
  "14:07:00": 24,
  "14:12:00": 1,
  "14:17:00": 2,
  "14:22:00": 3,
  "14:26:00": 25,
  "14:31:00": 4,
  "14:36:00": 5,
  "14:41:00": 6,
  "14:46:00": 7,
  "14:51:00": 8,
  "14:57:00": 9,
  "15:02:00": 10,
  "15:07:00": 11,
  "15:12:00": 12,
  "15:17:00": 13,
  "15:23:00": 14,
  "15:28:00": 15,
  "15:33:00": 16,
  "15:38:00": 17,
  "15:43:00": 18,
  "15:49:00": 19,
  "15:54:00": 26,
  "15:59:00": 20,
  "16:04:00": 21,
  "16:09:00": 22,
  "16:14:00": 23,
  "16:20:00": 24,
  "16:25:00": 1,
  "16:30:00": 2,
  "16:35:00": 3,
  "16:40:00": 25,
  "16:46:00": 4,
  "16:51:00": 5,
  "16:56:00": 6,
  "17:01:00": 7,
  "17:07:00": 8,
  "17:12:00": 9,
  "17:17:00": 10,
  "17:23:00": 11,
  "17:28:00": 12,
  "17:33:00": 13,
  "17:38:00": 14,
  "17:44:00": 15,
  "17:49:00": 16,
  "17:54:00": 17,
  "18:00:00": 18,
  "18:05:00": 19,
  "18:10:00": 26,
  "18:16:00": 20,
  "18:21:00": 21,
  "18:26:00": 22,
  "18:32:00": 23,
  "18:37:00": 24,
  "18:42:00": 1,
  "18:47:00": 2,
  "18:53:00": 3,
  "18:58:00": 25,
  "19:03:00": 4,
  "19:09:00": 5,
  "19:14:00": 6,
  "19:19:00": 7,
  "19:25:00": 8,
  "19:30:00": 9,
  "19:35:00": 10,
  "19:41:00": 11,
  "19:46:00": 12,
  "19:51:00": 13,
  "19:57:00": 14,
  "20:02:00": 15,
  "20:08:00": 16,
  "20:13:00": 17,
  "20:19:00": 19,
  "20:24:00": 26,
  "20:30:00": 20,
  "20:35:00": 21,
  "20:41:00": 23,
  "20:46:00": 24,
  "20:52:00": 1,
  "20:58:00": 2,
  "21:00:00": 3,
  "21:01:00": 25,
  "21:04:00": 4,
  "21:10:00": 5,
  "21:17:00": 6,
  "21:23:00": 7,
  "21:30:00": 8,
  "21:35:00": 9,
  "21:37:00": 10,
  "21:44:00": 11,
  "21:50:00": 12,
  "21:57:00": 13,
  "22:00:00": 15,
  "22:04:00": 17,
  "22:10:00": 19,
  "22:17:00": 26,
  "22:25:00": 20,
  "22:28:00": 21,
  "22:33:00": 24,
  "22:41:00": 1,
  "22:50:00": 2,
  "22:57:00": 3,
  "23:05:00": 6,
  "23:12:00": 7,
  "23:20:00": 9,
  "23:35:00": 11,
  "23:41:00": 12,
  "23:50:00": 19
};
const URLS = [
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20723", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20863", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20262", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20906", timetable: timetableMapB },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20910", timetable: timetableMapB },
	{ url: "https://beograd.prometko.si/api/stations/arrivals?station=20728", timetable: timetableMapB },
];
const CLEAN_REGEX = /[^\d:.]/g;

// --- 2. OVO JE GLAVNA VERCEL FUNKCIJA ---
export default async function handler(request, response) {
    let allResults = [];
    
    for (const { url, timetable } of URLS) {
        try {
            const apiResponse = await fetch(url);
            if (!apiResponse.ok) continue;
            
            const data = await apiResponse.json();
            const arrivals = data.data && data.data.arrivals ? data.data.arrivals : null;
            if (!arrivals || arrivals.length === 0) continue;

            arrivals
                .filter((bus) => bus.lc === "50")
                .forEach((bus) => {
                    const vehicleId = bus.i;
                    let apiTime = bus.dt;
                    if (!apiTime) return;

                    apiTime = apiTime.trim().replace(CLEAN_REGEX, '');
                    if (apiTime.includes('.')) apiTime = apiTime.split('.')[0];
                    if (apiTime.length === 5 && apiTime.includes(':')) apiTime = apiTime + ":00";
                    
                    const blockNumber = timetable[apiTime];

                    if (blockNumber) {
                        allResults.push({
                            time: apiTime,
                            block: blockNumber,
                            vehicle: vehicleId,
                        });
                    }
                });
        } catch (error) {
            // Ignorišemo greške pojedinačnih stanica
            console.error(`Greška pri dohvatanju ${url}:`, error.message);
        }
    }

    // Filtriranje i sortiranje
    const uniqueResults = allResults.filter((item, index, self) =>
        index === self.findIndex((t) => (t.block === item.block && t.vehicle === item.vehicle))
    );
    uniqueResults.sort((a, b) => a.block - b.block);

    // --- 3. SLANJE PODATAKA STRANICI ---
    // Umesto console.log, šaljemo JSON odgovor
    
    // Kažemo pregledaču da kešira odgovor na 1 minut (60 sekundi)
    // Ovo sprečava da vaš sajt obara prometko.si ako imate puno poseta
    response.setHeader('Cache-Control', 's-maxage=60, stale-while-revalidate=300');
    
    response.status(200).json({
        lastUpdated: new Date().toISOString(),
        results: uniqueResults
    });
}