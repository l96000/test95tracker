// Fajl: api/get-data.js

import fetch from 'node-fetch';

// --- 1. KOMPLETAN RED VOŽNJE (Vaši podaci) ---
const timetableMapA = {
"05:20:00": 21,
"05:40:00": 1,
"05:55:00": 4,
"06:05:00": 6,
"06:13:00": 8,
"06:20:00": 22,
"06:26:00": 9,
"06:32:00": 10,
"06:38:00": 11,
"06:43:00": 12,
"06:49:00": 13,
"06:55:00": 14,
"07:00:00": 15,
"07:06:00": 24,
"07:12:00": 16,
"07:18:00": 17,
"07:24:00": 18,
"07:30:00": 19,
"07:36:00": 20,
"07:42:00": 21,
"07:48:00": 23,
"07:54:00": 1,
"08:00:00": 2,
"08:06:00": 3,
"08:13:00": 4,
"08:20:00": 5,
"08:27:00": 6,
"08:34:00": 7,
"08:41:00": 8,
"08:45:00": 22,
"08:48:00": 9,
"08:55:00": 10,
"09:02:00": 11,
"09:09:00": 12,
"09:17:00": 13,
"09:24:00": 14,
"09:32:00": 15,
"09:37:00": 24,
"09:39:00": 16,
"09:46:00": 17,
"09:54:00": 18,
"10:01:00": 19,
"10:08:00": 20,
"10:16:00": 21,
"10:23:00": 1,
"10:31:00": 2,
"10:38:00": 3,
"10:45:00": 4,
"10:53:00": 5,
"11:00:00": 6,
"11:07:00": 7,
"11:15:00": 8,
"11:22:00": 9,
"11:30:00": 10,
"11:37:00": 11,
"11:44:00": 12,
"11:51:00": 13,
"11:58:00": 14,
"12:05:00": 15,
"12:12:00": 16,
"12:19:00": 17,
"12:26:00": 18,
"12:33:00": 19,
"12:40:00": 20,
"12:47:00": 22,
"12:54:00": 21,
"13:00:00": 1,
"13:07:00": 2,
"13:14:00": 3,
"13:21:00": 4,
"13:28:00": 5,
"13:35:00": 6,
"13:42:00": 7,
"13:49:00": 24,
"13:56:00": 8,
"14:03:00": 9,
"14:10:00": 10,
"14:17:00": 11,
"14:24:00": 12,
"14:30:00": 13,
"14:37:00": 14,
"14:44:00": 15,
"14:50:00": 23,
"14:57:00": 16,
"15:04:00": 17,
"15:10:00": 18,
"15:17:00": 19,
"15:24:00": 20,
"15:30:00": 22,
"15:37:00": 21,
"15:44:00": 1,
"15:50:00": 2,
"15:57:00": 3,
"16:04:00": 4,
"16:10:00": 5,
"16:17:00": 6,
"16:24:00": 7,
"16:30:00": 24,
"16:37:00": 8,
"16:44:00": 9,
"16:50:00": 10,
"16:57:00": 11,
"17:04:00": 12,
"17:10:00": 13,
"17:17:00": 14,
"17:23:00": 15,
"17:30:00": 23,
"17:36:00": 16,
"17:43:00": 17,
"17:49:00": 18,
"17:56:00": 19,
"18:02:00": 20,
"18:09:00": 22,
"18:12:00": 21,
"18:15:00": 1,
"18:22:00": 2,
"18:28:00": 3,
"18:35:00": 4,
"18:41:00": 5,
"18:48:00": 6,
"18:54:00": 7,
"19:01:00": 24,
"19:07:00": 8,
"19:14:00": 9,
"19:20:00": 10,
"19:27:00": 11,
"19:34:00": 12,
"19:40:00": 13,
"19:47:00": 14,
"19:54:00": 15,
"20:01:00": 16,
"20:08:00": 17,
"20:15:00": 19,
"20:22:00": 20,
"20:30:00": 1,
"20:36:00": 2,
"20:38:00": 3,
"20:46:00": 4,
"20:55:00": 6,
"21:04:00": 7,
"21:13:00": 8,
"21:22:00": 9,
"21:33:00": 10,
"21:38:00": 11,
"21:44:00": 12,
"21:56:00": 13,
"22:08:00": 14,
"22:20:00": 16,
"22:25:00": 17,
"22:35:00": 19,
"22:50:00": 20,
"23:05:00": 3,
"23:10:00": 6,
"23:20:00": 8,
"23:40:00": 10
};
const timetableMapB = {


 "04:30:00": 1,
  "04:55:00": 6,
  "05:15:00": 9,
  "05:35:00": 12,
  "05:50:00": 15,
  "06:00:00": 16,
  "06:06:00": 17,
  "06:12:00": 18,
  "06:17:00": 19,
  "06:23:00": 20,
  "06:29:00": 21,
  "06:35:00": 23,
  "06:40:00": 1,
  "06:46:00": 2,
  "06:52:00": 3,
  "06:57:00": 4,
  "07:03:00": 5,
  "07:09:00": 6,
  "07:15:00": 7,
  "07:20:00": 8,
  "07:26:00": 22,
  "07:32:00": 9,
  "07:37:00": 10,
  "07:43:00": 11,
  "07:50:00": 12,
  "07:57:00": 13,
  "08:04:00": 14,
  "08:11:00": 15,
  "08:18:00": 24,
  "08:25:00": 16,
  "08:32:00": 17,
  "08:39:00": 18,
  "08:46:00": 19,
  "08:53:00": 20,
  "09:00:00": 21,
  "09:03:00": 23,
  "09:07:00": 1,
  "09:14:00": 2,
  "09:21:00": 3,
  "09:28:00": 4,
  "09:35:00": 5,
  "09:42:00": 6,
  "09:49:00": 7,
  "09:56:00": 8,
  "10:03:00": 9,
  "10:10:00": 10,
  "10:17:00": 11,
  "10:24:00": 12,
  "10:32:00": 13,
  "10:40:00": 14,
  "10:47:00": 15,
  "10:55:00": 16,
  "11:03:00": 17,
  "11:10:00": 18,
  "11:18:00": 19,
  "11:26:00": 20,
  "11:33:00": 21,
  "11:41:00": 1,
  "11:48:00": 2,
  "11:56:00": 3,
  "12:04:00": 4,
  "12:11:00": 5,
  "12:19:00": 6,
  "12:27:00": 7,
  "12:34:00": 8,
  "12:42:00": 9,
  "12:49:00": 10,
  "12:57:00": 11,
  "13:04:00": 12,
  "13:10:00": 13,
  "13:17:00": 14,
  "13:24:00": 15,
  "13:30:00": 23,
  "13:37:00": 16,
  "13:44:00": 17,
  "13:50:00": 18,
  "13:57:00": 19,
  "14:04:00": 20,
  "14:10:00": 22,
  "14:17:00": 21,
  "14:24:00": 1,
  "14:30:00": 2,
  "14:37:00": 3,
  "14:44:00": 4,
  "14:50:00": 5,
  "14:57:00": 6,
  "15:04:00": 7,
  "15:10:00": 24,
  "15:17:00": 8,
  "15:24:00": 9,
  "15:30:00": 10,
  "15:37:00": 11,
  "15:44:00": 12,
  "15:50:00": 13,
  "15:57:00": 14,
  "16:04:00": 15,
  "16:10:00": 23,
  "16:17:00": 16,
  "16:24:00": 17,
  "16:30:00": 18,
  "16:37:00": 19,
  "16:44:00": 20,
  "16:50:00": 22,
  "16:57:00": 21,
  "17:04:00": 1,
  "17:10:00": 2,
  "17:17:00": 3,
  "17:24:00": 4,
  "17:30:00": 5,
  "17:37:00": 6,
  "17:44:00": 7,
  "17:50:00": 24,
  "17:57:00": 8,
  "18:04:00": 9,
  "18:10:00": 10,
  "18:17:00": 11,
  "18:24:00": 12,
  "18:30:00": 13,
  "18:37:00": 14,
  "18:44:00": 15,
  "18:45:00": 23,
  "18:52:00": 16,
  "19:00:00": 17,
  "19:04:00": 18,
  "19:07:00": 19,
  "19:15:00": 20,
  "19:19:00": 22,
  "19:23:00": 1,
  "19:31:00": 2,
  "19:38:00": 3,
  "19:46:00": 4,
  "19:51:00": 5,
  "19:54:00": 6,
  "20:02:00": 7,
  "20:06:00": 24,
  "20:10:00": 8,
  "20:17:00": 9,
  "20:25:00": 10,
  "20:33:00": 11,
  "20:41:00": 12,
  "20:50:00": 13,
  "21:00:00": 14,
  "21:04:00": 15,
  "21:10:00": 16,
  "21:20:00": 17,
  "21:30:00": 19,
  "21:41:00": 20,
  "21:43:00": 1,
  "21:53:00": 3,
  "21:55:00": 4,
  "22:05:00": 6,
  "22:14:00": 7,
  "22:20:00": 8,
  "22:32:00": 9,
  "22:40:00": 10,
  "22:50:00": 12,
  "23:00:00": 13,
  "23:08:00": 14,
  "23:25:00": 16,
  "23:40:00": 19,
  "23:55:00": 20
};
const URLS = [
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=22124", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20181", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20268", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=22131", timetable: timetableMapB },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20496", timetable: timetableMapB },
	{ url: "https://beograd.prometko.si/api/stations/arrivals?station=20727", timetable: timetableMapB },
];
const CLEAN_REGEX = /[^\d:.]/g;

// --- 2. OVO JE GLAVNA VERCEL FUNKCIJA ---
export default async function handler(request, response) {
    let allResults = [];
    
    for (const { url, timetable } of URLS) {
        try {
            const apiResponse = await fetch(url);
            if (!apiResponse.ok) continue;
            
            const data = await apiResponse.json();
            const arrivals = data.data && data.data.arrivals ? data.data.arrivals : null;
            if (!arrivals || arrivals.length === 0) continue;

            arrivals
                .filter((bus) => bus.lc === "37")
                .forEach((bus) => {
                    const vehicleId = bus.i;
                    let apiTime = bus.dt;
                    if (!apiTime) return;

                    apiTime = apiTime.trim().replace(CLEAN_REGEX, '');
                    if (apiTime.includes('.')) apiTime = apiTime.split('.')[0];
                    if (apiTime.length === 5 && apiTime.includes(':')) apiTime = apiTime + ":00";
                    
                    const blockNumber = timetable[apiTime];

                    if (blockNumber) {
                        allResults.push({
                            time: apiTime,
                            block: blockNumber,
                            vehicle: vehicleId,
                        });
                    }
                });
        } catch (error) {
            // Ignorišemo greške pojedinačnih stanica
            console.error(`Greška pri dohvatanju ${url}:`, error.message);
        }
    }

    // Filtriranje i sortiranje
    const uniqueResults = allResults.filter((item, index, self) =>
        index === self.findIndex((t) => (t.block === item.block && t.vehicle === item.vehicle))
    );
    uniqueResults.sort((a, b) => a.block - b.block);

    // --- 3. SLANJE PODATAKA STRANICI ---
    // Umesto console.log, šaljemo JSON odgovor
    
    // Kažemo pregledaču da kešira odgovor na 1 minut (60 sekundi)
    // Ovo sprečava da vaš sajt obara prometko.si ako imate puno poseta
    response.setHeader('Cache-Control', 's-maxage=60, stale-while-revalidate=300');
    
    response.status(200).json({
        lastUpdated: new Date().toISOString(),
        results: uniqueResults
    });
}