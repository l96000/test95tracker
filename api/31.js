// Fajl: api/get-data.js

import fetch from 'node-fetch';

// --- 1. KOMPLETAN RED VOŽNJE (Vaši podaci) ---
const timetableMapA = {
      "04:35:00": 1,
  "04:55:00": 9,
  "05:15:00": 13,
  "05:35:00": 1,
  "05:49:00": 5,
  "05:57:00": 8,
  "06:05:00": 9,
  "06:13:00": 10,
  "06:20:00": 12,
  "06:26:00": 13,
  "06:32:00": 14,
  "06:38:00": 16,
  "06:43:00": 18,
  "06:48:00": 19,
  "06:53:00": 1,
  "06:57:00": 2,
  "07:01:00": 3,
  "07:06:00": 4,
  "07:10:00": 5,
  "07:14:00": 6,
  "07:18:00": 7,
  "07:22:00": 8,
  "07:26:00": 9,
  "07:30:00": 10,
  "07:35:00": 11,
  "07:39:00": 12,
  "07:43:00": 13,
  "07:47:00": 14,
  "07:51:00": 15,
  "07:56:00": 16,
  "08:00:00": 17,
  "08:04:00": 18,
  "08:08:00": 19,
  "08:13:00": 1,
  "08:17:00": 2,
  "08:21:00": 3,
  "08:25:00": 4,
  "08:29:00": 5,
  "08:34:00": 6,
  "08:38:00": 7,
  "08:42:00": 8,
  "08:46:00": 9,
  "08:50:00": 10,
  "08:55:00": 11,
  "08:59:00": 12,
  "09:03:00": 13,
  "09:07:00": 14,
  "09:11:00": 15,
  "09:16:00": 16,
  "09:20:00": 17,
  "09:24:00": 18,
  "09:28:00": 19,
  "09:33:00": 1,
  "09:37:00": 2,
  "09:41:00": 3,
  "09:45:00": 4,
  "09:49:00": 5,
  "09:54:00": 6,
  "09:58:00": 7,
  "10:02:00": 8,
  "10:06:00": 9,
  "10:10:00": 10,
  "10:15:00": 11,
  "10:19:00": 12,
  "10:23:00": 13,
  "10:27:00": 14,
  "10:31:00": 15,
  "10:36:00": 16,
  "10:40:00": 17,
  "10:44:00": 18,
  "10:48:00": 19,
  "10:53:00": 1,
  "10:57:00": 2,
  "11:01:00": 3,
  "11:05:00": 4,
  "11:09:00": 5,
  "11:14:00": 6,
  "11:18:00": 7,
  "11:22:00": 8,
  "11:26:00": 9,
  "11:30:00": 10,
  "11:35:00": 11,
  "11:39:00": 12,
  "11:43:00": 13,
  "11:47:00": 14,
  "11:51:00": 15,
  "11:56:00": 16,
  "12:00:00": 17,
  "12:04:00": 18,
  "12:08:00": 19,
  "12:13:00": 1,
  "12:17:00": 2,
  "12:21:00": 3,
  "12:25:00": 4,
  "12:29:00": 5,
  "12:34:00": 6,
  "12:38:00": 7,
  "12:42:00": 8,
  "12:46:00": 9,
  "12:50:00": 10,
  "12:55:00": 11,
  "12:59:00": 12,
  "13:03:00": 13,
  "13:07:00": 14,
  "13:11:00": 15,
  "13:16:00": 16,
  "13:20:00": 17,
  "13:24:00": 18,
  "13:28:00": 19,
  "13:33:00": 1,
  "13:37:00": 2,
  "13:41:00": 3,
  "13:45:00": 4,
  "13:49:00": 5,
  "13:54:00": 6,
  "13:58:00": 7,
  "14:02:00": 8,
  "14:06:00": 9,
  "14:10:00": 10,
  "14:15:00": 11,
  "14:19:00": 12,
  "14:23:00": 13,
  "14:27:00": 14,
  "14:31:00": 15,
  "14:36:00": 16,
  "14:40:00": 17,
  "14:44:00": 18,
  "14:48:00": 19,
  "14:53:00": 1,
  "14:57:00": 2,
  "15:01:00": 3,
  "15:05:00": 4,
  "15:09:00": 5,
  "15:14:00": 6,
  "15:18:00": 7,
  "15:22:00": 8,
  "15:26:00": 9,
  "15:30:00": 10,
  "15:35:00": 11,
  "15:39:00": 12,
  "15:43:00": 13,
  "15:47:00": 14,
  "15:51:00": 15,
  "15:56:00": 16,
  "16:00:00": 17,
  "16:04:00": 18,
  "16:08:00": 19,
  "16:13:00": 1,
  "16:17:00": 2,
  "16:21:00": 3,
  "16:25:00": 4,
  "16:29:00": 5,
  "16:34:00": 6,
  "16:38:00": 7,
  "16:42:00": 8,
  "16:46:00": 9,
  "16:50:00": 10,
  "16:55:00": 11,
  "16:59:00": 12,
  "17:03:00": 13,
  "17:07:00": 14,
  "17:11:00": 15,
  "17:16:00": 16,
  "17:20:00": 17,
  "17:24:00": 18,
  "17:28:00": 19,
  "17:33:00": 1,
  "17:37:00": 2,
  "17:41:00": 3,
  "17:45:00": 4,
  "17:49:00": 5,
  "17:54:00": 6,
  "17:58:00": 7,
  "18:02:00": 8,
  "18:06:00": 9,
  "18:10:00": 10,
  "18:15:00": 11,
  "18:19:00": 12,
  "18:23:00": 13,
  "18:27:00": 14,
  "18:31:00": 15,
  "18:36:00": 16,
  "18:40:00": 17,
  "18:44:00": 18,
  "18:48:00": 19,
  "18:53:00": 1,
  "18:57:00": 2,
  "19:01:00": 3,
  "19:05:00": 4,
  "19:09:00": 5,
  "19:14:00": 6,
  "19:18:00": 7,
  "19:23:00": 8,
  "19:28:00": 9,
  "19:33:00": 10,
  "19:38:00": 11,
  "19:43:00": 13,
  "19:48:00": 14,
  "19:53:00": 15,
  "19:56:00": 16,
  "19:58:00": 17,
  "20:03:00": 18,
  "20:08:00": 19,
  "20:13:00": 1,
  "20:18:00": 2,
  "20:23:00": 3,
  "20:25:00": 4,
  "20:28:00": 5,
  "20:33:00": 6,
  "20:38:00": 7,
  "20:43:00": 8,
  "20:48:00": 9,
  "20:53:00": 10,
  "20:55:00": 11,
  "20:58:00": 12,
  "21:04:00": 14,
  "21:07:00": 15,
  "21:11:00": 17,
  "21:18:00": 18,
  "21:25:00": 1,
  "21:33:00": 3,
  "21:41:00": 5,
  "21:46:00": 6,
  "21:49:00": 8,
  "21:57:00": 9,
  "22:05:00": 12,
  "22:13:00": 14,
  "22:21:00": 17,
  "22:29:00": 18,
  "22:37:00": 1,
  "22:39:00": 3,
  "22:46:00": 5,
  "22:55:00": 8,
  "23:05:00": 9,
  "23:15:00": 12,
  "23:25:00": 14,
  "23:35:00": 17,
  "23:45:00": 18,
  "00:00:00": 1,
  "00:05:00": 8,
  "00:35:00": 14
};
const timetableMapB = {
 "04:05:00": 1,
  "04:25:00": 9,
  "04:45:00": 13,
  "05:05:00": 1,
  "05:15:00": 8,
  "05:25:00": 9,
  "05:34:00": 10,
  "05:42:00": 13,
  "05:49:00": 14,
  "05:56:00": 16,
  "06:02:00": 18,
  "06:08:00": 19,
  "06:14:00": 1,
  "06:20:00": 3,
  "06:25:00": 4,
  "06:30:00": 5,
  "06:35:00": 7,
  "06:40:00": 8,
  "06:45:00": 9,
  "06:50:00": 10,
  "06:55:00": 11,
  "06:59:00": 12,
  "07:03:00": 13,
  "07:07:00": 14,
  "07:11:00": 15,
  "07:16:00": 16,
  "07:20:00": 17,
  "07:24:00": 18,
  "07:28:00": 19,
  "07:33:00": 1,
  "07:37:00": 2,
  "07:41:00": 3,
  "07:45:00": 4,
  "07:49:00": 5,
  "07:54:00": 6,
  "07:58:00": 7,
  "08:02:00": 8,
  "08:06:00": 9,
  "08:10:00": 10,
  "08:15:00": 11,
  "08:19:00": 12,
  "08:23:00": 13,
  "08:27:00": 14,
  "08:31:00": 15,
  "08:36:00": 16,
  "08:40:00": 17,
  "08:44:00": 18,
  "08:48:00": 19,
  "08:53:00": 1,
  "08:57:00": 2,
  "09:01:00": 3,
  "09:05:00": 4,
  "09:09:00": 5,
  "09:14:00": 6,
  "09:18:00": 7,
  "09:22:00": 8,
  "09:26:00": 9,
  "09:30:00": 10,
  "09:35:00": 11,
  "09:39:00": 12,
  "09:43:00": 13,
  "09:47:00": 14,
  "09:51:00": 15,
  "09:56:00": 16,
  "10:00:00": 17,
  "10:04:00": 18,
  "10:08:00": 19,
  "10:13:00": 1,
  "10:17:00": 2,
  "10:21:00": 3,
  "10:25:00": 4,
  "10:29:00": 5,
  "10:34:00": 6,
  "10:38:00": 7,
  "10:42:00": 8,
  "10:46:00": 9,
  "10:50:00": 10,
  "10:55:00": 11,
  "10:59:00": 12,
  "11:03:00": 13,
  "11:07:00": 14,
  "11:11:00": 15,
  "11:16:00": 16,
  "11:20:00": 17,
  "11:24:00": 18,
  "11:28:00": 19,
  "11:33:00": 1,
  "11:37:00": 2,
  "11:41:00": 3,
  "11:45:00": 4,
  "11:49:00": 5,
  "11:54:00": 6,
  "11:58:00": 7,
  "12:02:00": 8,
  "12:06:00": 9,
  "12:10:00": 10,
  "12:15:00": 11,
  "12:19:00": 12,
  "12:23:00": 13,
  "12:27:00": 14,
  "12:31:00": 15,
  "12:36:00": 16,
  "12:40:00": 17,
  "12:44:00": 18,
  "12:48:00": 19,
  "12:53:00": 1,
  "12:57:00": 2,
  "13:01:00": 3,
  "13:05:00": 4,
  "13:09:00": 5,
  "13:14:00": 6,
  "13:18:00": 7,
  "13:22:00": 8,
  "13:26:00": 9,
  "13:30:00": 10,
  "13:35:00": 11,
  "13:39:00": 12,
  "13:43:00": 13,
  "13:47:00": 14,
  "13:51:00": 15,
  "13:56:00": 16,
  "14:00:00": 17,
  "14:04:00": 18,
  "14:08:00": 19,
  "14:13:00": 1,
  "14:17:00": 2,
  "14:21:00": 3,
  "14:25:00": 4,
  "14:29:00": 5,
  "14:34:00": 6,
  "14:38:00": 7,
  "14:42:00": 8,
  "14:46:00": 9,
  "14:50:00": 10,
  "14:55:00": 11,
  "14:59:00": 12,
  "15:03:00": 13,
  "15:07:00": 14,
  "15:11:00": 15,
  "15:16:00": 16,
  "15:20:00": 17,
  "15:24:00": 18,
  "15:28:00": 19,
  "15:33:00": 1,
  "15:37:00": 2,
  "15:41:00": 3,
  "15:45:00": 4,
  "15:49:00": 5,
  "15:54:00": 6,
  "15:58:00": 7,
  "16:02:00": 8,
  "16:06:00": 9,
  "16:10:00": 10,
  "16:15:00": 11,
  "16:19:00": 12,
  "16:23:00": 13,
  "16:27:00": 14,
  "16:31:00": 15,
  "16:36:00": 16,
  "16:40:00": 17,
  "16:44:00": 18,
  "16:48:00": 19,
  "16:53:00": 1,
  "16:57:00": 2,
  "17:01:00": 3,
  "17:05:00": 4,
  "17:09:00": 5,
  "17:14:00": 6,
  "17:18:00": 7,
  "17:22:00": 8,
  "17:26:00": 9,
  "17:30:00": 10,
  "17:35:00": 11,
  "17:39:00": 12,
  "17:43:00": 13,
  "17:47:00": 14,
  "17:51:00": 15,
  "17:56:00": 16,
  "18:00:00": 17,
  "18:04:00": 18,
  "18:08:00": 19,
  "18:13:00": 1,
  "18:17:00": 2,
  "18:21:00": 3,
  "18:25:00": 4,
  "18:29:00": 5,
  "18:34:00": 6,
  "18:38:00": 7,
  "18:42:00": 8,
  "18:46:00": 9,
  "18:50:00": 10,
  "18:55:00": 11,
  "18:59:00": 12,
  "19:03:00": 13,
  "19:07:00": 14,
  "19:11:00": 15,
  "19:16:00": 16,
  "19:20:00": 17,
  "19:24:00": 18,
  "19:28:00": 19,
  "19:33:00": 1,
  "19:37:00": 2,
  "19:41:00": 3,
  "19:45:00": 4,
  "19:49:00": 5,
  "19:54:00": 6,
  "19:58:00": 7,
  "20:03:00": 8,
  "20:08:00": 9,
  "20:13:00": 10,
  "20:18:00": 11,
  "20:23:00": 12,
  "20:28:00": 14,
  "20:34:00": 15,
  "20:40:00": 17,
  "20:46:00": 18,
  "20:48:00": 19,
  "20:52:00": 1,
  "20:55:00": 2,
  "20:58:00": 3,
  "21:04:00": 5,
  "21:10:00": 6,
  "21:13:00": 7,
  "21:16:00": 8,
  "21:22:00": 9,
  "21:24:00": 10,
  "21:29:00": 12,
  "21:36:00": 14,
  "21:43:00": 17,
  "21:50:00": 18,
  "21:57:00": 1,
  "22:04:00": 3,
  "22:12:00": 5,
  "22:20:00": 8,
  "22:29:00": 9,
  "22:38:00": 12,
  "22:47:00": 14,
  "22:56:00": 17,
  "23:05:00": 18,
  "23:15:00": 1,
  "23:21:00": 5,
  "23:30:00": 8,
  "23:41:00": 9,
  "23:48:00": 12,
  "00:00:00": 14,
  "00:10:00": 17,
  "00:20:00": 18,
  "00:33:00": 1
};
const URLS = [
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20221", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20148", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20197", timetable: timetableMapA },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20650", timetable: timetableMapB },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20147", timetable: timetableMapB },
    { url: "https://beograd.prometko.si/api/stations/arrivals?station=20381", timetable: timetableMapB },
];
const CLEAN_REGEX = /[^\d:.]/g;

// --- 2. OVO JE GLAVNA VERCEL FUNKCIJA ---
export default async function handler(request, response) {
    let allResults = [];
    
    for (const { url, timetable } of URLS) {
        try {
            const apiResponse = await fetch(url);
            if (!apiResponse.ok) continue;
            
            const data = await apiResponse.json();
            const arrivals = data.data && data.data.arrivals ? data.data.arrivals : null;
            if (!arrivals || arrivals.length === 0) continue;

            arrivals
                .filter((bus) => bus.lc === "31")
                .forEach((bus) => {
                    const vehicleId = bus.i;
                    let apiTime = bus.dt;
                    if (!apiTime) return;

                    apiTime = apiTime.trim().replace(CLEAN_REGEX, '');
                    if (apiTime.includes('.')) apiTime = apiTime.split('.')[0];
                    if (apiTime.length === 5 && apiTime.includes(':')) apiTime = apiTime + ":00";
                    
                    const blockNumber = timetable[apiTime];

                    if (blockNumber) {
                        allResults.push({
                            time: apiTime,
                            block: blockNumber,
                            vehicle: vehicleId,
                        });
                    }
                });
        } catch (error) {
            // Ignorišemo greške pojedinačnih stanica
            console.error(`Greška pri dohvatanju ${url}:`, error.message);
        }
    }

    // Filtriranje i sortiranje
    const uniqueResults = allResults.filter((item, index, self) =>
        index === self.findIndex((t) => (t.block === item.block && t.vehicle === item.vehicle))
    );
    uniqueResults.sort((a, b) => a.block - b.block);

    // --- 3. SLANJE PODATAKA STRANICI ---
    // Umesto console.log, šaljemo JSON odgovor
    
    // Kažemo pregledaču da kešira odgovor na 1 minut (60 sekundi)
    // Ovo sprečava da vaš sajt obara prometko.si ako imate puno poseta
    response.setHeader('Cache-Control', 's-maxage=60, stale-while-revalidate=300');
    
    response.status(200).json({
        lastUpdated: new Date().toISOString(),
        results: uniqueResults
    });
}